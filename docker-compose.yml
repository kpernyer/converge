# Converge Local Development Environment
# Usage:
#   just dev-up      # Start all services
#   just dev-down    # Stop all services
#   just dev-logs    # View logs
#
# Or directly with docker compose:
#   docker compose up -d
#   docker compose down

services:
  # ===========================================
  # Firebase Emulators (Firestore + UI)
  # ===========================================
  firebase:
    build:
      context: ./docker/firebase
      dockerfile: Dockerfile
    container_name: converge-firebase
    ports:
      - "4000:4000"   # Emulator Suite UI
      - "8080:8080"   # Firestore
      - "9099:9099"   # Auth (if needed later)
    environment:
      - FIRESTORE_EMULATOR_HOST=0.0.0.0:8080
    volumes:
      - firebase-data:/app/data
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:4000"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s

  # ===========================================
  # Converge Runtime (Local Development)
  # ===========================================
  runtime:
    build:
      context: .
      dockerfile: docker/Dockerfile.dev
    container_name: converge-runtime
    ports:
      - "3000:3000"   # Runtime API
    environment:
      - RUST_LOG=debug
      - LOCAL_DEV=true
      - FIRESTORE_EMULATOR_HOST=firebase:8080
      - GCP_PROJECT_ID=demo-converge
      - HTTP_PORT=3000
    depends_on:
      firebase:
        condition: service_healthy
    volumes:
      # Mount source for live reloading (cargo-watch)
      - ./converge-core:/app/converge-core:ro
      - ./converge-domain:/app/converge-domain:ro
      - ./converge-provider:/app/converge-provider:ro
      - ./converge-runtime:/app/converge-runtime:ro
      - ./converge-tool:/app/converge-tool:ro
      - ./Cargo.toml:/app/Cargo.toml:ro
      - ./Cargo.lock:/app/Cargo.lock:ro
      - cargo-cache:/usr/local/cargo/registry
      - target-cache:/app/target
    profiles:
      - full  # Only start with: docker compose --profile full up

  # ===========================================
  # Alternative: Just run cargo locally
  # ===========================================
  # For faster iteration, run the runtime locally:
  #   just dev-up         # Start firebase only
  #   just dev-run        # Run runtime with emulator

volumes:
  firebase-data:
    name: converge-firebase-data
  cargo-cache:
    name: converge-cargo-cache
  target-cache:
    name: converge-target-cache

networks:
  default:
    name: converge-dev
